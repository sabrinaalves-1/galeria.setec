<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Galeria de Fotos</title>
  <style>
    :root{
      --azul-claro:#a8e6ff;
      --roxo-claro:#d7b3ff;
      --branco:#ffffff;
      --preto:#0a0a0a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,sans-serif;
      background: linear-gradient(135deg,var(--azul-claro),var(--roxo-claro));
      color: var(--preto);
      min-height: 100vh;
    }

    /* Topo */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 20px;
      background: linear-gradient(90deg, rgba(255,255,255,0.25), rgba(0,0,0,0.08));
      backdrop-filter: blur(6px);
    }
    .topbar .brand{font-weight:700}
    .menu button{
      margin-left:8px;
      padding:8px 12px;
      border-radius:8px;
      border:0;
      background:rgba(255,255,255,0.9);
      cursor:pointer;
    }

    /* Layout */
    .container{display:flex;gap:16px;padding:16px;flex-wrap:wrap}
    .sidebar{width:260px;padding:12px;border-radius:12px;background:rgba(255,255,255,0.5)}
    .gallery-area{flex:1;display:flex;flex-direction:column;gap:12px}

    /* Dropzone */
    .dropzone{
      padding:18px;
      border-radius:12px;
      border:2px dashed rgba(0,0,0,0.12);
      text-align:center;
      background:rgba(255,255,255,0.25);
      cursor:pointer;
    }

    /* TÃ­tulos de cada dia */
    .gallery-area h3{text-align:center;margin:16px 0 8px 0;font-size:1.2rem;color:var(--preto)}

    /* Galeria */
    .gallery{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap:8px;
      justify-content:center;
      max-height:calc(100vh - 250px);
      overflow-y:auto;
      padding:4px;
    }

    /* Cards */
    .card{
      position:relative;
      overflow:hidden;
      border-radius:10px;
      background:var(--branco);
      display:flex;
      flex-direction:column;
      aspect-ratio:1/1;
      animation:flashBox 0.3s ease;
    }
    .card img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      transition:transform .28s ease, filter .28s ease;
      cursor:pointer;
    }
    .card .desc{
      padding:4px;
      font-size:0.7rem;
      text-align:center;
      background:rgba(255,255,255,0.75);
    }
    .card:hover img{
      transform:scale(1.05);
      filter:contrast(1.05) saturate(1.05);
    }

    /* BotÃ£o remover */
    .remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }
    .remove-btn:hover{background:rgba(255,0,0,0.8)}

    /* ===== Modal ===== */
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1200;
    }
    .modal.hidden { display: none; }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      position: relative;
      z-index: 2;
      background: var(--branco);
      padding: 12px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      max-width: 90vw;
      max-height: 90vh;
      overflow: hidden;
    }
    .modal-content img {
      max-width: 90vw;
      max-height: 80vh;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: 0 0 25px rgba(0,0,0,0.8);
      transition: transform .2s ease;
    }
    .modal-controls {display:flex;gap:8px}
    .modal-controls button{
      padding:8px 10px;
      border-radius:8px;
      border:0;
      cursor:pointer;
    }
    .modal-desc{
      max-width:90vw;
      text-align:center;
      font-size:0.9rem;
      color:var(--texto,#333);
    }

    /* Flash */
    @keyframes flashBox{
      0%{opacity:0;transform:scale(0.95)}
      100%{opacity:1;transform:scale(1)}
    }

    /* Responsivo */
    @media (max-width:900px){
      .container{flex-direction:column}
      .sidebar{width:100%}
      .gallery{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:480px){
      .gallery{grid-template-columns:repeat(1,1fr)}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">Galeria â€¢ Barbosa</div>
    <nav class="menu">
      <button id="btnAdd">Adicionar</button>
      <button id="btnCamera">Camera</button>
      <button id="btnFromUrl">Adicionar por URL</button>
      <button id="btnClearAll">Limpar tudo</button>
    </nav>
  </header>

  <main class="container">
    <aside class="sidebar">
      <h2>InstruÃ§Ãµes</h2>
      <p>Use o botÃ£o <strong>Camera</strong> para abrir a cÃ¢mera. Ou arraste imagens para a Ã¡rea principal.</p>
      <p>Ao adicionar via URL, o site farÃ¡ o download da imagem, aplicarÃ¡ a marca d'Ã¡gua e salvarÃ¡ localmente.</p>
    </aside>

    <section class="gallery-area">
      <div id="dropzone" class="dropzone">Arraste imagens aqui ou clique em "Adicionar"</div>

      <h3>ðŸ“… Dia 1</h3>
      <div id="gallery1" class="gallery"></div>

      <h3>ðŸ“… Dia 2</h3>
      <div id="gallery2" class="gallery"></div>

      <h3>ðŸ“… Dia 3</h3>
      <div id="gallery3" class="gallery"></div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal-content">
      <img id="modalImg" alt="PrÃ©-visualizaÃ§Ã£o">
      <div class="modal-controls">
        <button id="zoomIn">+</button>
        <button id="zoomOut">-</button>
        <button id="closeModal">Fechar</button>
      </div>
      <p id="modalDesc" class="modal-desc"></p>
    </div>
  </div>

  <input id="fileInput" type="file" accept="image/*" multiple capture="environment" style="display:none">

  <script>
    const STORAGE_KEY = 'galeriaFotos_v4';
    const galleries = [document.getElementById('gallery1'), document.getElementById('gallery2'), document.getElementById('gallery3')];
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const btnAdd = document.getElementById('btnAdd');
    const btnCamera = document.getElementById('btnCamera');
    const btnFromUrl = document.getElementById('btnFromUrl');
    const btnClearAll = document.getElementById('btnClearAll');

    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const modalDesc = document.getElementById('modalDesc');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const closeModalBtn = document.getElementById('closeModal');
    const zoomIn = document.getElementById('zoomIn');
    const zoomOut = document.getElementById('zoomOut');

    let currentScale = 1;
    let items = JSON.parse(localStorage.getItem(STORAGE_KEY))||[];
    render();

    // Eventos principais
    btnAdd.addEventListener('click', ()=>fileInput.click());
    btnCamera.addEventListener('click', ()=>{
      fileInput.setAttribute('capture','environment');
      fileInput.click();
    });
    btnFromUrl.addEventListener('click', async ()=>{
      const url = prompt('Cole a URL da imagem:');
      if(!url) return;
      try{ await addImageFromUrl(url); alert('Imagem adicionada!'); }catch(e){ alert('Erro: '+e.message); }
    });
    btnClearAll.addEventListener('click', ()=>{
      if(confirm('Remover todas as imagens?')){ items=[]; save(); render(); }
    });

    fileInput.addEventListener('change', async (ev)=>{
      for(const f of Array.from(ev.target.files||[])) await addFile(f);
      fileInput.value='';
    });

    // Drag & Drop
    ['dragenter','dragover'].forEach(ev=>dropzone.addEventListener(ev,e=>{ e.preventDefault(); dropzone.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev=>dropzone.addEventListener(ev,e=>{ e.preventDefault(); dropzone.classList.remove('drag'); }));
    dropzone.addEventListener('drop', async (e)=>{
      for(const f of Array.from(e.dataTransfer.files||[])) await addFile(f);
    });
    dropzone.addEventListener('click', ()=>fileInput.click());

    // Modal
    function openModal(item){
      modalImg.src=item.dataUrl;
      modalDesc.textContent=item.desc||('Adicionada em '+new Date(item.createdAt).toLocaleString());
      currentScale=1; modalImg.style.transform='scale(1)';
      modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
    }
    function closeModalFn(){ 
      modal.classList.add('hidden'); 
      modal.setAttribute('aria-hidden','true'); 
    }
    closeModalBtn.addEventListener('click', closeModalFn);
    modalBackdrop.addEventListener('click', closeModalFn);
    window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModalFn(); });
    zoomIn.addEventListener('click', ()=>{ currentScale=Math.min(3,currentScale+0.2); modalImg.style.transform=`scale(${currentScale})`; });
    zoomOut.addEventListener('click', ()=>{ currentScale=Math.max(0.5,currentScale-0.2); modalImg.style.transform=`scale(${currentScale})`; });

    // Storage
    function save(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(items)); }

    // Adicionar arquivos
    async function addFile(file){
      if(!file.type.startsWith('image/')) return;
      const dataUrl = await fileToDataURL(file);
      const watermarked = await applyWatermark(dataUrl);
      const dia = prompt('Qual o dia da imagem? (1,2 ou 3)', '1');
      const item = { id: randomId(), dataUrl: watermarked, desc:file.name, dia:Math.min(3,Math.max(1,parseInt(dia)||1)), createdAt: Date.now() };
      items.unshift(item); save(); render();
    }
    async function addImageFromUrl(url){
      const res = await fetch(url); if(!res.ok) throw new Error('Falha no download');
      const blob = await res.blob(); if(!blob.type.startsWith('image/')) throw new Error('NÃ£o Ã© uma imagem');
      const dataUrl = await blobToDataURL(blob);
      const watermarked = await applyWatermark(dataUrl);
      const dia = prompt('Qual o dia da imagem? (1,2 ou 3)', '1');
      items.unshift({ id: randomId(), dataUrl: watermarked, desc:url, dia:Math.min(3,Math.max(1,parseInt(dia)||1)), createdAt: Date.now() });
      save(); render();
    }

    // Helpers
    function fileToDataURL(file){return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });}
    function blobToDataURL(blob){return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(blob); });}
    function randomId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
    function applyWatermark(dataUrl){
      return new Promise((res)=>{
        const img=new Image(); img.crossOrigin='anonymous';
        img.onload = ()=>{
          const canvas=document.createElement('canvas'); canvas.width=img.width; canvas.height=img.height;
          const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0);
          ctx.fillStyle='rgba(0,0,0,0.18)'; ctx.fillRect(20,img.height-60,img.width-40,50);
          ctx.fillStyle='rgba(255,255,255,0.85)';
          ctx.font=Math.round(Math.max(12,img.width*0.02))+'px sans-serif';
          ctx.fillText('Galeria â€¢ Barbosa',30,img.height-30);
          res(canvas.toDataURL('image/jpeg',0.9));
        };
        img.onerror=()=>res(dataUrl);
        img.src=dataUrl;
      });
    }

    // Render
    function render(){
      galleries.forEach(g=>g.innerHTML='');
      if(items.length===0){ galleries.forEach(g=>g.innerHTML='<p>Nenhuma imagem</p>'); return; }
      for(const item of items){
        const card=document.createElement('article'); card.className='card';

        const removeBtn=document.createElement('button');
        removeBtn.className='remove-btn';
        removeBtn.textContent='Ã—';
        removeBtn.addEventListener('click',()=>{
          if(confirm('Remover esta imagem?')){
            items=items.filter(it=>it.id!==item.id);
            save(); render();
          }
        });

        const img=document.createElement('img');
        img.src=item.dataUrl; img.alt=item.desc||'';
        img.addEventListener('click',()=>openModal(item));

        const desc=document.createElement('div');
        desc.className='desc'; desc.textContent=item.desc||'';

        card.appendChild(removeBtn);
        card.appendChild(img);
        card.appendChild(desc);
        galleries[item.dia-1].appendChild(card);
      }
    }
  </script>
</body>
</html>
